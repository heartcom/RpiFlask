<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <title>LED + DHT11</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet" />
  <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">

  <!-- 테이블 레이아웃 강제 리셋 (열 깨짐 방지) -->
  <style>
    #history-table { table-layout: fixed; width: 100%; }
    #history-body { display: table-row-group !important; }
    #history-body tr { display: table-row !important; }
    #history-body td, #history-table thead th { display: table-cell !important; }

    /* 차트 카드만 폭 넓히기 */
    .sensor-card.chart-wide { max-width: 800px; }
    #chart-wrap { max-width: 100%; height: 260px; margin: 0 auto; }

    @media (max-width: 576px) { 
      #chart-wrap { height: 220px; } 
    }
  </style>

  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
  <div class="container py-5">
    <h1 class="mb-4 title-name text-center">Raspberry Pi GPIO 제어 &amp; DHT11 모니터</h1>

    <div class="text-center mb-4">
      <a href="/on/" class="btn btn-danger btn-lg me-2">LED ON</a>
      <a href="/off/" class="btn btn-secondary btn-lg">LED OFF</a>
    </div>

    <!-- LED 상태 -->
    <p class="status text-center mb-5">
      LED 상태: <span id="state"><strong>{{ state }}</strong></span>
    </p>

    <!-- 온습도 카드 -->
    <div class="card sensor-card mx-auto">
      <div class="card-body">
        <h4 class="card-title mb-3">DHT11 온습도</h4>

        <!-- 온도 -->
        <p class="sensor-row">
          <span class="sensor-label">온도:</span>
          <span class="sensor-value">
            <span id="temp" class="num">
              {% if temperature is not none %}{{ "%.1f"|format(temperature) }}{% else %}—{% endif %}
            </span>
          </span>
          <span class="sensor-unit">°C</span>
        </p>

        <!-- 습도 -->
        <p class="sensor-row">
          <span class="sensor-label">습도:</span>
          <span class="sensor-value">
            <span id="humi" class="num">
              {% if humidity is not none %}{{ "%.1f"|format(humidity) }}{% else %}—{% endif %}
            </span>
          </span>
          <span class="sensor-unit">%</span>
        </p>

        <small class="text-muted" id="updated">
          {% if updated_at %}업데이트: {{ updated_at }}{% else %}&nbsp;{% endif %}
        </small>
      </div>
    </div>

    <!-- 최근 측정 테이블 (최신값이 위) -->
    <div class="card sensor-card mx-auto mt-4">
      <div class="card-body">
        <h5 class="card-title mb-3">측정 데이터</h5>

        <div id="history-table-wrap"
             style="max-width:460px; margin:0 auto; border:1px solid #333; border-radius:8px; overflow:auto; max-height:600px;">
          <table id="history-table" class="table table-dark table-striped table-hover table-sm mb-0 align-middle">
            <colgroup>
              <col style="width:46%">
              <col style="width:27%">
              <col style="width:27%">
            </colgroup>
            <thead>
              <tr style="position:sticky; top:0; background:#222; z-index:1;">
                <th>측정 시간</th>
                <th class="text-end">온도(°C)</th>
                <th class="text-end">습도(%)</th>
              </tr>
            </thead>
            <tbody id="history-body"></tbody>
          </table>
        </div>
      </div>
    </div>

    <!-- 차트 (차트 카드만 폭 넓힘) -->
    <div class="card sensor-card chart-wide mx-auto mt-4">
      <div class="card-body">
        <h5 class="card-title mb-3">온습도 그래프</h5>
        <div id="chart-wrap">
          <canvas id="history-chart"></canvas>
        </div>
      </div>
    </div>
  </div>

  <!-- 현재값 자동 갱신 -->
  <script>
    function refreshDHT() {
      fetch('/api/dht')
        .then(r => r.json())
        .then(d => {
          if (!d || !d.ok) return;
          if (d.temp_c != null) document.getElementById('temp').textContent = Number(d.temp_c).toFixed(1);
          if (d.humidity != null) document.getElementById('humi').textContent = Number(d.humidity).toFixed(1);
          if (d.updated_at) document.getElementById('updated').textContent = '업데이트: ' + d.updated_at;
        })
        .catch(err => console.error('refreshDHT error:', err));
    }
    refreshDHT();
    setInterval(refreshDHT, 3000);
  </script>

  <!-- 테이블 + 차트 자동 갱신 -->
  <script>
    function rowHtml(r) {
      const ts = (r.ts ?? '-');
      const t  = (r.temp_c ?? '-');
      const h  = (r.humidity ?? '-');
      return `<tr>
        <td>${ts}</td>
        <td class="text-end">${t}</td>
        <td class="text-end">${h}</td>
      </tr>`;
    }

    let historyChart = null;

    function upsertChart(labels, temps, humis) {
      if (typeof Chart === 'undefined') {
        console.warn('Chart.js not loaded; skip chart render.');
        return;
      }
      const ctx = document.getElementById('history-chart');
      if (!historyChart) {
        historyChart = new Chart(ctx, {
          type: 'line',
          data: {
            labels,
            datasets: [
              { label: '온도(°C)', data: temps, borderColor: 'red', fill: false },
              { label: '습도(%)', data: humis, borderColor: 'blue', fill: false }
            ]
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            interaction: { mode: 'index', intersect: false },
            plugins: { legend: { display: true }, tooltip: { enabled: true } },
            scales: { x: { grid: { display: false } }, y: { beginAtZero: false } }
          }
        });
      } else {
        historyChart.data.labels = labels;
        historyChart.data.datasets[0].data = temps;
        historyChart.data.datasets[1].data = humis;
        historyChart.update();
      }
    }

    async function fetchHistory() {
      try {
        const r = await fetch('/api/dht-history');
        const j = await r.json();
        if (!j.ok) return;

        const rows = j.rows || [];
        document.getElementById('history-body').innerHTML = rows.map(rowHtml).join('');

        const recent = rows.slice(0, 100).reverse();
        const labels = recent.map(x => x.ts);
        const temps  = recent.map(x => (x.temp_c ?? null));
        const humis  = recent.map(x => (x.humidity ?? null));
        upsertChart(labels, temps, humis);
      } catch (e) {
        console.error('fetchHistory error:', e);
      }
    }

    fetchHistory();
    setInterval(fetchHistory, 3000);
  </script>
</body>
</html>
