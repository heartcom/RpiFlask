<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <title>LED + DHT11</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet" />
  <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">

  <!-- 테이블 레이아웃 강제 리셋 (열 깨짐 방지) -->
  <style>
    #history-table { table-layout: fixed; width: 100%; }
    #history-body { display: table-row-group !important; }
    #history-body tr { display: table-row !important; }
    #history-body td, #history-table thead th { display: table-cell !important; }
  </style>
</head>
<body>
  <div class="container py-5">
    <h1 class="mb-4 title-name text-center">Raspberry Pi GPIO 제어 &amp; DHT11 모니터</h1>

    <div class="text-center mb-4">
      <a href="/on/" class="btn btn-danger btn-lg me-2">LED ON</a>
      <a href="/off/" class="btn btn-secondary btn-lg">LED OFF</a>
    </div>

    <!-- LED 상태 -->
    <p class="status text-center mb-5">
      LED 상태: <span id="state"><strong>{{ state }}</strong></span>
    </p>

    <!-- 온습도 카드 -->
    <div class="card sensor-card mx-auto">
      <div class="card-body">
        <h4 class="card-title mb-3">DHT11 온습도</h4>

        <!-- 온도 -->
        <p class="sensor-row">
          <span class="sensor-label">온도:</span>
          <span class="sensor-value">
            <span id="temp" class="num">
              {% if temperature is not none %}{{ "%.1f"|format(temperature) }}{% else %}—{% endif %}
            </span>
          </span>
          <span class="sensor-unit">°C</span>
        </p>

        <!-- 습도 -->
        <p class="sensor-row">
          <span class="sensor-label">습도:</span>
          <span class="sensor-value">
            <span id="humi" class="num">
              {% if humidity is not none %}{{ "%.1f"|format(humidity) }}{% else %}—{% endif %}
            </span>
          </span>
          <span class="sensor-unit">%</span>
        </p>

        <small class="text-muted" id="updated">
          {% if updated_at %}업데이트: {{ updated_at }}{% else %}&nbsp;{% endif %}
        </small>
      </div>
    </div>

    <!-- 최근 측정 테이블 (최신값이 위) -->
    <div class="card sensor-card mx-auto mt-4">
      <div class="card-body">
        <h5 class="card-title mb-3">측정 데이터</h5>

        <!-- 스크롤은 래퍼 div에만 적용 -->
        <div id="history-table-wrap"
             style="max-width:460px; margin:0 auto; border:1px solid #333; border-radius:8px; overflow:auto; max-height:600px;">
          <table id="history-table" class="table table-dark table-striped table-hover table-sm mb-0 align-middle">
            <!-- 고정 폭: 46% / 27% / 27% -->
            <colgroup>
              <col style="width:46%">
              <col style="width:27%">
              <col style="width:27%">
            </colgroup>
            <thead>
              <tr style="position:sticky; top:0; background:#222; z-index:1;">
                <th>측정 시간</th>
                <th class="text-end">온도(°C)</th>
                <th class="text-end">습도(%)</th>
              </tr>
            </thead>
            <tbody id="history-body">
              <!-- JS로 채움 -->
            </tbody>
          </table>
        </div>
      </div>
    </div>
    <!-- /최근 측정 테이블 -->

  </div>

  <!-- 현재값 3초마다 자동 갱신 (기존 코드 유지) -->
  <script>
    function refreshDHT() {
      fetch('/api/dht')
        .then(r => r.json())
        .then(d => {
          if (!d || !d.ok) return;
          if (d.temp_c !== null && d.temp_c !== undefined) {
            document.getElementById('temp').textContent = Number(d.temp_c).toFixed(1);
          }
          if (d.humidity !== null && d.humidity !== undefined) {
            document.getElementById('humi').textContent = Number(d.humidity).toFixed(1);
          }
          if (d.updated_at) {
            document.getElementById('updated').textContent = '업데이트: ' + d.updated_at;
          }
        })
        .catch(() => {});
    }
    refreshDHT();                 // 최초 1회
    setInterval(refreshDHT, 3000); // 3초마다 갱신
  </script>

  <!-- 히스토리 테이블 자동 갱신 -->
  <script>
    function rowHtml(r) {
      const ts = (r.ts ?? '-');
      const t  = (r.temp_c ?? '-');
      const h  = (r.humidity ?? '-');
      return `<tr>
        <td>${ts}</td>
        <td class="text-end">${t}</td>
        <td class="text-end">${h}</td>
      </tr>`;
    }

    async function fetchHistory() {
      try {
        const r = await fetch('/api/dht-history');
        const j = await r.json();
        if (!j.ok) return;
        const rows = j.rows || [];  // 서버에서 최신순으로 내려옴
        document.getElementById('history-body').innerHTML = rows.map(rowHtml).join('');
      } catch (e) { /* ignore */ }
    }

    fetchHistory();                  // 최초 1회
    setInterval(fetchHistory, 3000); // 3초마다 갱신
  </script>
</body>
</html>
